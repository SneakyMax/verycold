[gd_scene load_steps=11 format=2]

[ext_resource path="res://StartMenu.tscn" type="PackedScene" id=1]
[ext_resource path="res://Fonts/Roboto-Light.ttf" type="DynamicFontData" id=2]
[ext_resource path="res://Audio/CameraShutter_2.wav" type="AudioStream" id=3]
[ext_resource path="res://Audio/Uber.wav" type="AudioStream" id=4]
[ext_resource path="res://Audio/Cold.wav" type="AudioStream" id=5]

[sub_resource type="GDScript" id=1]

script/source = "extends Node

export(PackedScene) var start_level

export(Array, String) var game_levels

var levelHolder : Node
var bigText : Label

var current_level : Node
var currentBigTextTimer : Timer
var currentLevelIndex : int
var tween : Tween

var allow_input = true

var isSlomo
var startSlomoTime
var slomoSecondsFixed : float
var slomoAmount

var textSound

func _ready():
	OS.window_fullscreen = true
	levelHolder = get_node(\"Current Level\")
	bigText = get_node(\"Overlay UI/Big Text\")
	textSound = get_node(\"TextSound\")
	tween = get_node(\"Tween\")
	start_over()
	
func slomo(secondsFixed : float, amount: float):
	Engine.time_scale = amount
	isSlomo = true
	startSlomoTime = OS.get_ticks_msec()
	slomoSecondsFixed = secondsFixed
	slomoAmount = amount

func _process(delta):
	var now = OS.get_ticks_msec()
	var slomoChangeTime = 2.0
	if isSlomo:
		var after = now - (startSlomoTime + (slomoSecondsFixed * 1000))
		if after >= 0:
			var slomoFactor = after / (slomoChangeTime * 1000)
			var timeScale = clamp(lerp(slomoAmount, 1, slomoFactor), 0.1, 1)
			Engine.time_scale = timeScale
			if timeScale == 1:
				isSlomo = false
				
func start_over():
	currentLevelIndex = -1
	set_level(start_level)
				
func next_level():
	currentLevelIndex += 1
	if currentLevelIndex >= game_levels.size():
		start_over()
		return
	var newLevel = load(game_levels[currentLevelIndex])
	set_level(newLevel)
	
func restart_level():
	set_level(load(game_levels[currentLevelIndex]))
	
func set_level(level : PackedScene):
	Engine.time_scale = 1
	get_tree().paused = false
	
	if is_instance_valid(current_level):
		current_level.queue_free()
		yield(get_tree(), \"idle_frame\")

	current_level = level.instance()
	levelHolder.add_child(current_level)

func player_died():
	clearBigText()
	get_tree().paused = true
	allow_input = false
	var dead = get_node(\"Overlay UI\").find_node(\"Dead\")
	dead.visible = true
	tween().interpolate_property(dead, \"modulate:a\", 0.5, 1, 1, Tween.TRANS_QUAD, Tween.EASE_OUT)
	
	yield(delay(2, true, false), \"timeout\")
	
	restart_level()
	dead.modulate.a = 0
	dead.visible = false
	
func delay(seconds : float = 1, start : bool = true, pausable : bool = true):
	var timer = Timer.new()
	
	var parent = get_node(\"Current Level\") if pausable else self
	parent.add_child(timer)
	
	timer.one_shot = true
	timer.wait_time = seconds
	if start:
		timer.start()
	return timer
	
func clearBigText():
	bigText.text = \"\"
	
func showBigText(text : String, totalTime : float = 2):
	if currentBigTextTimer and !currentBigTextTimer.is_stopped():
		currentBigTextTimer.stop()
	
	var words = text.split(\" \")
	var timer = delay(totalTime / words.size())
	timer.one_shot = false
	currentBigTextTimer = timer
	
	for word in words:
		textSound.play()
		bigText.text = word
		bigText.rect_scale = Vector2(1.0, 1.0)
		tween.interpolate_property(bigText, \"rect_scale\", 
			Vector2(1.0, 1.0),
			Vector2(0.75, 0.75),
			min(0.5, timer.wait_time), Tween.TRANS_QUAD, Tween.EASE_OUT)
		tween.start()
		yield(timer, \"timeout\")
	
	clearBigText()
	
func playGameName(times : int):
	var timer = delay(0.65, true, false)
	timer.one_shot = false
	for time in range(0, times):
		showBigText(\"UBER COLD\", 0.65 * 2)
		get_node(\"Audio/Uber\").pitch_scale = Engine.time_scale
		get_node(\"Audio/Uber\").play()
		yield(timer, \"timeout\")
		get_node(\"Audio/Cold\").pitch_scale = Engine.time_scale
		get_node(\"Audio/Cold\").play()
		yield(timer, \"timeout\")
	
func level_add(obj):
	current_level.add_child(obj)
	
func tween():
	var tween = Tween.new()
	add_child(tween)
	tween.start()
	return tween"

[sub_resource type="Gradient" id=2]

offsets = PoolRealArray( 0 )
colors = PoolColorArray( 1, 1, 1, 1 )

[sub_resource type="GradientTexture" id=3]

flags = 4
gradient = SubResource( 2 )
width = 1423
_sections_unfolded = [ "gradient" ]

[sub_resource type="DynamicFont" id=4]

size = 295
outline_size = 1
outline_color = Color( 0, 0, 0, 1 )
use_mipmaps = false
use_filter = false
font_data = ExtResource( 2 )
_sections_unfolded = [ "Fallback", "Font", "Settings", "font_data" ]

[sub_resource type="GDScript" id=5]

script/source = "extends Label

func _process(_delta):
	rect_pivot_offset = rect_size / 2.0"

[node name="Game" type="Node"]
pause_mode = 2
script = SubResource( 1 )
_sections_unfolded = [ "Pause", "game_levels", "start_level" ]
start_level = ExtResource( 1 )
game_levels = [ "res://Level4Hard.tscn", "res://Level5.tscn", "res://Level2.tscn", "res://Level3.tscn", "res://Level.tscn", "res://Level4.tscn", "res://Level6.tscn" ]

[node name="Overlay UI" type="Control" parent="."]
anchor_left = 0.0
anchor_top = 0.0
anchor_right = 1.0
anchor_bottom = 1.0
margin_top = -2.0
margin_bottom = -2.0
rect_pivot_offset = Vector2( 0, 0 )
rect_clip_content = false
mouse_filter = 2
mouse_default_cursor_shape = 0
size_flags_horizontal = 1
size_flags_vertical = 1
_sections_unfolded = [ "Anchor", "Mouse", "Pause", "Rect" ]

[node name="Dead" type="TextureRect" parent="Overlay UI"]
visible = false
modulate = Color( 1, 0, 0, 0.552941 )
anchor_left = 0.0
anchor_top = 0.0
anchor_right = 1.0
anchor_bottom = 1.0
rect_pivot_offset = Vector2( 0, 0 )
rect_clip_content = false
mouse_filter = 2
mouse_default_cursor_shape = 0
size_flags_horizontal = 1
size_flags_vertical = 1
texture = SubResource( 3 )
expand = true
stretch_mode = 0
_sections_unfolded = [ "Material", "Mouse", "Theme", "Visibility", "texture" ]

[node name="Big Text" type="Label" parent="Overlay UI"]
anchor_left = 0.0
anchor_top = 0.5
anchor_right = 1.0
anchor_bottom = 0.5
margin_top = -172.0
margin_bottom = 175.0
rect_pivot_offset = Vector2( 512, 124 )
rect_clip_content = false
mouse_filter = 2
mouse_default_cursor_shape = 0
size_flags_horizontal = 1
size_flags_vertical = 4
custom_fonts/font = SubResource( 4 )
align = 1
valign = 1
percent_visible = 1.0
lines_skipped = 0
max_lines_visible = -1
script = SubResource( 5 )
_sections_unfolded = [ "Anchor", "Custom Fonts", "Grow Direction", "Margin", "Rect", "Theme", "custom_fonts", "custom_fonts/font", "custom_styles" ]

[node name="Current Level" type="Node" parent="."]
pause_mode = 1
_sections_unfolded = [ "Pause", "Script" ]

[node name="TextSound" type="AudioStreamPlayer" parent="."]
stream = ExtResource( 3 )
volume_db = -3.391
pitch_scale = 0.8
autoplay = false
stream_paused = false
mix_target = 0
bus = "Master"

[node name="Audio" type="Node" parent="."]
_sections_unfolded = [ "Pause" ]

[node name="Uber" type="AudioStreamPlayer" parent="Audio"]
stream = ExtResource( 4 )
volume_db = 0.0
pitch_scale = 1.0
autoplay = false
stream_paused = false
mix_target = 0
bus = "Master"

[node name="Cold" type="AudioStreamPlayer" parent="Audio"]
stream = ExtResource( 5 )
volume_db = 0.0
pitch_scale = 1.0
autoplay = false
stream_paused = false
mix_target = 0
bus = "Master"

[node name="Tween" type="Tween" parent="."]
repeat = false
playback_process_mode = 1
playback_speed = 1.0
playback/active = false
playback/repeat = false
playback/speed = 1.0
_sections_unfolded = [ "playback" ]

